{% extends 'base.html' %}

{% block title %}Editar Ordem de Serviço #{{ os.id }}{% endblock %}

{% block content %}
<h2 class="mb-4">Editar Ordem de Serviço #{{ os.id }}</h2>

<form method="POST" action="{{ url_for('editar_os', os_id=os.id) }}">
  <div class="mb-3">
    <label for="cliente" class="form-label">Cliente</label>
    <select name="cliente_id" id="cliente" class="form-select" disabled>
      <option value="{{ os.cliente.id }}">{{ os.cliente.nome }}</option>
    </select>
    <input type="hidden" name="cliente_id" value="{{ os.cliente.id }}">
  </div>

  <div class="mb-3">
    <label for="data_criacao" class="form-label">Data de Criação</label>
    <input type="date" name="data_criacao" id="data_criacao" class="form-control"
           value="{{ os.data_criacao.strftime('%Y-%m-%d') }}">
  </div>

  <div class="mb-3">
    <label for="status" class="form-label">Status</label>
    <select name="status" id="status" class="form-select">
      {% for s in ['Aberta', 'Em andamento', 'Finalizada', 'Cancelada', 'Pago'] %}
        <option value="{{ s }}" {% if os.status == s %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="mb-3">
    <label for="desconto" class="form-label">Desconto (R$)</label>
    <input type="number" step="0.01" name="desconto" id="desconto" class="form-control"
           value="{{ os.desconto or 0 }}">
  </div>

  <hr>
  <h5>Itens da Ordem</h5>
  {% for item in os.itens_os %}
    <div class="border p-3 mb-3">
      <div class="mb-2">
        <strong>{{ item.produto.nome }}</strong> — {{ item.produto.descricao }}
      </div>
      <div class="row">
        <div class="col-md-4">
          <label class="form-label">Quantidade</label>
          <input type="number" name="quantidade_{{ item.id }}" class="form-control"
                 value="{{ item.quantidade }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Preço Unitário</label>
          <input type="number" step="0.01" name="preco_{{ item.id }}" class="form-control"
                 value="{{ item.produto.preco }}">
        </div>
        <div class="col-md-4 d-flex justify-content-end align-items-end">
          <button type="submit" name="excluir_item" value="{{ item.id }}" class="btn btn-outline-danger btn-sm" title="Excluir">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
       </div>
    </div>
  {% endfor %}

  <hr>
  <h5>Adicionar Novo Item</h5>
  <div class="row mb-3">
    <div class="col-md-6">
      <label for="novo_produto_id" class="form-label">Produto</label>
      <select name="novo_produto_id" id="novo_produto_id" class="form-select">
        {% for produto in produtos %}
          <option value="{{ produto.id }}">{{ produto.nome }} — R$ {{ '%.2f'|format(produto.preco) }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label for="nova_quantidade" class="form-label">Quantidade</label>
      <input type="number" name="nova_quantidade" id="nova_quantidade" class="form-control" value="1">
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button type="submit" name="adicionar_item" value="1" class="btn btn-outline-success w-100">
        Adicionar Item
      </button>
    </div>
  </div>

  <button type="submit" class="btn btn-primary">Salvar Alterações</button>
  <a href="{{ url_for('visualizar_os', os_id=os.id) }}" class="btn btn-secondary">Cancelar</a>
</form>
{% endblock %}
