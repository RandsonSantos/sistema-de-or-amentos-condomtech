{% extends 'base.html' %}
{% block title %}Nova O.S.{% endblock %}

{% block content %}
<h2>Nova Ordem de Serviço</h2>

<form method="POST" action="{{ url_for('nova_os') }}">
  {% if cliente %}
    <input type="hidden" name="cliente" value="{{ cliente.id }}">
    <p><strong>Cliente:</strong> {{ cliente.nome }}</p>
  {% else %}
    <select name="cliente" class="form-select mb-3" required>
      <option value="" disabled selected>Selecione um cliente</option>
      {% for c in clientes %}
        <option value="{{ c.id }}">{{ c.nome }}</option>
      {% endfor %}
    </select>
  {% endif %}

  <div id="itens">
    <div class="d-flex gap-2 mb-2">
      <select name="produto[]" class="form-select" required>
        <option value="" disabled selected>Produto</option>
        {% for p in produtos %}
          <option value="{{ p.id }}">{{ p.nome }} - R$ {{ '%.2f'|format(p.preco) }}</option>
        {% endfor %}
      </select>
      <input type="number" name="quantidade[]" class="form-control" placeholder="Qtd" min="1" required>
      <button type="button" class="btn btn-outline-danger" onclick="removerItem(this)">−</button>
    </div>
  </div>

  <button type="button" class="btn btn-outline-secondary mb-3" onclick="adicionarItem()">+ Item</button>

  <input type="number" name="desconto" id="desconto" class="form-control mb-3" placeholder="Desconto (R$)" step="0.01" min="0" value="0">

  <textarea name="observacoes" class="form-control mb-3" rows="2" placeholder="Observações"></textarea>

  <div class="text-end mb-3">
    <strong>Total: R$ <span id="total">0.00</span></strong>
  </div>

  <button type="submit" class="btn btn-success">Salvar</button>
</form>

<script>
  function adicionarItem() {
    const container = document.getElementById('itens');
    const novo = container.firstElementChild.cloneNode(true);
    novo.querySelector('select').selectedIndex = 0;
    novo.querySelector('input').value = '';
    container.appendChild(novo);
    atualizarTotal();
  }

  function removerItem(btn) {
    const linha = btn.closest('.d-flex');
    linha.remove();
    atualizarTotal();
  }

  function atualizarTotal() {
    let total = 0;
    document.querySelectorAll('#itens .d-flex').forEach(item => {
      const preco = item.querySelector('select').selectedOptions[0]?.text.match(/R\$ ([\d,.]+)/);
      const qtd = parseInt(item.querySelector('input').value);
      if (preco && !isNaN(qtd)) {
        total += parseFloat(preco[1].replace(',', '.')) * qtd;
      }
    });
    const desconto = parseFloat(document.getElementById('desconto').value) || 0;
    document.getElementById('total').textContent = (total - desconto).toFixed(2);
  }

  document.addEventListener('input', atualizarTotal);
  document.addEventListener('change', atualizarTotal);
</script>
{% endblock %}
